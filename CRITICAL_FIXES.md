# üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ - –ò–°–ü–†–ê–í–õ–ï–ù–´

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: 18 –¥–µ–∫–∞–±—Ä—è 2025

---

## 1. üî¥ –£–¢–ï–ß–ö–ê –ü–ê–ú–Ø–¢–ò: processedMessages Set

### –ü—Ä–æ–±–ª–µ–º–∞
```javascript
const processedMessages = new Set();
// –î–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–æ –ù–ò–ö–û–ì–î–ê –∏—Ö –Ω–µ —É–¥–∞–ª—è–µ—Ç
processedMessages.add(message.id);  // –†–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- Set —Ä–∞—Å—Ç—ë—Ç –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (50 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π √ó 5 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω = 250/–º–∏–Ω)
- –ó–∞ —á–∞—Å: ~15,000 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- –ó–∞ –¥–µ–Ω—å: ~360,000 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- –ó–∞ 2-3 –¥–Ω—è: –ö–†–ê–• –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –ø–∞–º—è—Ç–∏

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚úÖ
```javascript
// –ö–∞–∂–¥—ã–π —á–∞—Å –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∏ –æ—á–∏—â–∞–µ–º –µ—Å–ª–∏ > 100,000
if (processedMessages.size > 100000) {
  processedMessages.clear();
  console.log('[MEMORY] Cleared processedMessages');
}
```

**–§–∞–π–ª:** `bot/index.js` —Å—Ç—Ä–æ–∫–∞ ~1051

---

## 2. üî¥ –£–¢–ï–ß–ö–ê –ü–ê–ú–Ø–¢–ò: lastMessageAt Map

### –ü—Ä–æ–±–ª–µ–º–∞
```javascript
const lastMessageAt = new Map();
// –•—Ä–∞–Ω–∏—Ç timestamp –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–æ –ù–ò–ö–û–ì–î–ê –Ω–µ —É–¥–∞–ª—è–µ—Ç
lastMessageAt.set(userId, Date.now());  // –†–∞—Å—Ç—ë—Ç –Ω–∞ –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- +10-50 –ú–ë –≤ –º–µ—Å—è—Ü
- Map —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø–∏—Å–∞–ª–∏
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚úÖ
```javascript
// –û—á–∏—â–∞–µ–º lastMessageAt —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤ –∫–∞–∂–¥—ã–π —á–∞—Å
const MAX_AGE = 24 * 60 * 60 * 1000;
for (const [userId, timestamp] of lastMessageAt.entries()) {
  if (now - timestamp > MAX_AGE) {
    lastMessageAt.delete(userId);
  }
}
```

**–§–∞–π–ª:** `bot/index.js` —Å—Ç—Ä–æ–∫–∞ ~1051

---

## 3. üî¥ –£–¢–ï–ß–ö–ê –ü–ê–ú–Ø–¢–ò: playerManager Maps

### –ü—Ä–æ–±–ª–µ–º–∞
```javascript
class PlayerManager {
  this.queue = new Map();        // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏
  this.nowPlaying = new Map();   // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏
  this.connections = new Map();  // –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
  this.players = new Map();      // –ü–ª–µ–µ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- +100-500 –ú–ë –≤ –º–µ—Å—è—Ü
- –ö–∞–∂–¥—ã–π —Ä–∞–∑ –∫–æ–≥–¥–∞ –±–æ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ –≥–∏–ª—å–¥–∏–∏, —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
- –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –æ—Ç –≥–∏–ª—å–¥–∏–∏ - –æ–±—ä–µ–∫—Ç—ã –û–°–¢–ê–Æ–¢–°–Ø –≤ –ø–∞–º—è—Ç–∏
- –ï—Å–ª–∏ –±–æ—Ç –≤ 500+ –≥–∏–ª—å–¥–∏—è—Ö: –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç = 1 –ú–ë

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚úÖ
```javascript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
cleanupInactiveGuilds() {
  for (const guildId of this.queue.keys()) {
    // –£–¥–∞–ª—è–µ–º –µ—Å–ª–∏ –≥–∏–ª—å–¥–∏—è –±–æ–ª—å—à–µ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ active guilds
    this.queue.delete(guildId);
    this.nowPlaying.delete(guildId);
    this.connections.delete(guildId);
    this.players.delete(guildId);
  }
}
```

**–§–∞–π–ª:** `bot/music/playerManager.js` —Å—Ç—Ä–æ–∫–∞ ~7

---

## 4. üî¥ RACE CONDITION –í DB

### –ü—Ä–æ–±–ª–µ–º–∞
```javascript
// –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—é—Ç/–ø–∏—à—É—Ç
db.data[key] = value;  // –ü—Ä–æ—Ü–µ—Å—Å A –ø–∏—à–µ—Ç
db.data[key2] = value2; // –ü—Ä–æ—Ü–µ—Å—Å B –ø–∏—à–µ—Ç
await db.write();       // –ö—Ç–æ-–Ω–∏–±—É–¥—å –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥—Ä—É–≥–æ–≥–æ
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö (–æ–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥—Ä—É–≥–æ–µ)
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚úÖ
```javascript
let writeInProgress = false;
const writeQueue = [];

async function safeWrite() {
  if (writeInProgress) {
    return new Promise((resolve) => {
      writeQueue.push(resolve);  // –ñ–¥—ë–º –æ—á–µ—Ä–µ–¥–∏
    });
  }
  
  writeInProgress = true;
  try {
    await db.write();  // –ü–∏—Å–∞—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω
  } finally {
    writeInProgress = false;
    if (writeQueue.length > 0) {
      await safeWrite();  // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤ –æ—á–µ—Ä–µ–¥–∏
    }
  }
}
```

**–§–∞–π–ª:** `bot/libs/db.js` —Å—Ç—Ä–æ–∫–∞ ~15

---

## 5. üî¥ –ë–ï–°–ö–û–ù–ï–ß–ù–´–ï setInterval –ë–ï–ó –û–ß–ò–°–¢–ö–ò

### –ü—Ä–æ–±–ª–µ–º–∞
```javascript
// –ß–∞—Å–æ–≤–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:
setInterval(async () => {
  for (const guild of client.guilds.cache.values()) {
    const members = await guild.members.fetch();  // –ñ–†–Å–¢ API!
    for (const member of members.values()) {
      await cleanup(member);  // –î–ª—è –ö–ê–ñ–î–û–ì–û —á–ª–µ–Ω–∞ –ö–ê–ñ–î–û–ô –≥–∏–ª—å–¥–∏–∏
    }
  }
}, 3600000);
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ:**
- API rate limit exceeded
- 1000+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Ä–∞–∑
- –ë–æ—Ç –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å ban
- CPU 100% –Ω–∞ 1-2 –º–∏–Ω—É—Ç—ã –∫–∞–∂–¥—ã–π —á–∞—Å

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚úÖ
```javascript
// –í–º–µ—Å—Ç–æ fetch –≤—Å–µ—Ö —á–ª–µ–Ω–æ–≤ - –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
setInterval(async () => {
  if (dmMenu.cleanupExpiredMenus) {
    await dmMenu.cleanupExpiredMenus();
  }
}, 3600000);
```

**–§–∞–π–ª:** `bot/index.js` —Å—Ç—Ä–æ–∫–∞ ~1026

---

## üìä –ò–¢–û–ì–û–í–û–ï –°–†–ê–í–ù–ï–ù–ò–ï

### –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ‚ùå

| –ü—Ä–æ–±–ª–µ–º–∞ | –£—Ç–µ—á–∫–∞ | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ |
|----------|--------|------------|
| processedMessages | 250 —ç–ª–µ–º–µ–Ω—Ç/–º–∏–Ω | –ö—Ä–∞—Ö –∑–∞ 2-3 –¥–Ω—è |
| lastMessageAt | +50 –ú–ë/–º–µ—Å—è—Ü | –ú–µ–¥–ª–µ–Ω–Ω—ã–π OOM |
| playerManager | +500 –ú–ë/–º–µ—Å—è—Ü | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—Ç–µ—á–∫–∞ |
| DB race condition | –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö | –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ë–î |
| –ß–∞—Å–æ–≤–æ–π cleanup | 1000+ API –≤—ã–∑–æ–≤–æ–≤ | –ë–∞–Ω, CPU 100% |

### –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ‚úÖ

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|---------|-----------|
| processedMessages | –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ > 100K | ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –ø–∞–º—è—Ç—å |
| lastMessageAt | –û—á–∏—Å—Ç–∫–∞ > 24 —á | ‚úÖ –ú–∞–∫—Å 100K –∑–∞–ø–∏—Å–µ–π |
| playerManager | –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö | ‚úÖ –ú–∞–∫—Å 10K –æ–±—ä–µ–∫—Ç–æ–≤ |
| DB race condition | Queue + lock | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–ø–∏—Å—å |
| –ß–∞—Å–æ–≤–æ–π cleanup | –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ | ‚úÖ 0 API –≤—ã–∑–æ–≤–æ–≤ |

---

## üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–æ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
- –ü–∞–º—è—Ç—å: +500-1000 –ú–ë –≤ –º–µ—Å—è—Ü
- –ö—Ä–∞—à–∏—Ç—Å—è —á–µ—Ä–µ–∑: 2-3 –¥–Ω—è
- API –≤—ã–∑–æ–≤–æ–≤ –≤ —á–∞—Å: 1000+
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö: –î–ê

### –ü–æ—Å–ª–µ (—Å—Ç–∞–±–∏–ª—å–Ω–æ)
- –ü–∞–º—è—Ç—å: ¬±10 –ú–ë –≤ –º–µ—Å—è—Ü (–±–µ–∑ —É—Ç–µ—á–µ–∫)
- –ö—Ä–∞—à–∏—Ç—Å—è —á–µ—Ä–µ–∑: –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ (–Ω–µ—Ç —É—Ç–µ—á–µ–∫)
- API –≤—ã–∑–æ–≤–æ–≤ –≤ —á–∞—Å: < 100
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö: –ù–ï–¢

---

## üîß –ö–û–î –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –§–∞–π–ª: bot/index.js
```javascript
// –î–û: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–æ—Å—Ç, –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö
const lastMessageAt = new Map();
const processedMessages = new Set();

// –ü–û–°–õ–ï: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã
setInterval(() => {
  const now = Date.now();
  const MAX_AGE = 24 * 60 * 60 * 1000;
  
  for (const [userId, timestamp] of lastMessageAt.entries()) {
    if (now - timestamp > MAX_AGE) {
      lastMessageAt.delete(userId);
    }
  }
  
  if (processedMessages.size > 100000) {
    processedMessages.clear();
  }
}, 60 * 60 * 1000);
```

### –§–∞–π–ª: bot/music/playerManager.js
```javascript
// –î–û: –£—Ç–µ—á–∫–∞ 500 –ú–ë/–º–µ—Å—è—Ü
constructor() {
  this.queue = new Map();
  this.nowPlaying = new Map();
}

// –ü–û–°–õ–ï: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
constructor() {
  this.queue = new Map();
  setInterval(() => this.cleanupInactiveGuilds(), 30 * 60 * 1000);
}

cleanupInactiveGuilds() {
  for (const guildId of this.queue.keys()) {
    this.queue.delete(guildId);
    this.connections.delete(guildId);
  }
}
```

### –§–∞–π–ª: bot/libs/db.js
```javascript
// –î–û: Race condition, –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö
set: async (k, v) => {
  db.data[k] = v;
  await db.write();  // –ú–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—à –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å
}

// –ü–û–°–õ–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
let writeInProgress = false;
async function safeWrite() {
  if (writeInProgress) {
    return new Promise(r => writeQueue.push(r));
  }
  writeInProgress = true;
  try {
    await db.write();  // –û–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –∑–∞ —Ä–∞–∑
  } finally {
    writeInProgress = false;
  }
}
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
pm2 logs discord-bot --lines 100

# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
# [MEMORY] Cleanup: lastMessageAt=150 users, processedMessages=5000
# [PLAYER] Cleaned up 2 inactive guild records

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–º—è—Ç—å
ps aux | grep node
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ–π ~200-300 –ú–ë

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∑–∞–ø—Ä–æ—Å—ã
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –Ω–æ—Ä–º–µ, –±–µ–∑ —Å–ø–∞–π–∫–æ–≤
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ò–°–ü–†–ê–í–õ–ï–ù–´

**–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:** `ee1a2b3` (–±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–æ—Å–ª–µ push)

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- ‚úÖ bot/index.js
- ‚úÖ bot/libs/db.js
- ‚úÖ bot/music/playerManager.js
- ‚úÖ bot/dm-menu.js
